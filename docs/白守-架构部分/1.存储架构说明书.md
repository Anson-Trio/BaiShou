# 白守 (BaiShou) 2.0 存储架构说明书
本文更新时间：2026-2-28

## 1. 核心设计哲学

白守 2.0 采用 **“物理文件 + SQLite 影子索引”** 的混合存储架构，旨在平衡数据主权、互操作性与极致的移动端性能。

- **物理文件**：所有日记、总结、附件均以标准 Markdown 和原始媒体文件形式存储。第三方应用（如 AI Agent）可直接读写，保障数据不被应用锁死。
- **影子索引**：在每个 Vault 内部维护隐藏的 SQLite 数据库（`.baishou/shadow_index.db`），作为物理文件的镜像索引，支撑毫秒级的检索与复杂聚合统计。

---

## 2. Vault 物理结构规范

每一个 Vault 都是一个独立的物理文件夹，具备完整的自完备性。

### 2.1 目录层级拓扑 (Global & Vault Hierarchy)
白守的数据由一个“根目录”统辖，下设全局注册中心与多个独立的数据仓（Vault）。

```text
📁 BaiShou_Root (数据根目录)
├── 📁 .baishou (全局注册中心)
│   ├── 📄 vault_registry.json    (多库索引：记录所有已知 Vault 路径)
│   └── 📁 global_settings.json   (全局偏好：语言、主题、全域 UI 状态)
│
├── 📁 Vault_Personal (生活空间库 / 示例)
│   ├── 📁 Journals (日志流)
│   │   └── 📁 2026 (年份层)
│   │       ├── 📄 2026-Report-Yearly.md  (年度总结)
│   │       ├── 📄 2026-Report-Month.md   (月度分析/月报)
│   │       └── 📁 02 (月份层)
│   │           ├── 📄 2026-02-28.md       (原子日记)
│   │           └── 📁 Assets              (该月专属资源池)
│   └── 📁 .baishou (空间元数据)
│       ├── 📄 shadow_index.db   (本地影子索引库)
│       └── 📄 ai_config.json    (该空间专属 AI 配置)
│
└── 📁 Vault_Professional (工作空间库 / 示例)
    ├── 📁 Journals
    └── 📁 .baishou
```

### 2.2 设计准则
1. **分析与细节解耦**：分析类 Report 放在年份根部，细节类 Log 放在月份内部。
2. **附件月份分切 (Media Sharding)**：资源文件存储在对应月份的 `Assets` 文件夹，规避单文件夹万级文件的 I/O 停顿。
3. **Markdown 格式约定**：必须包含 YAML Front Matter 存储元数据，示例如下：
```yaml
---
date: "2026-02-28"
mood: "Happy"
tags: ["Work", "Research"]
location: "user's location"
---
# 正文内容...
```

---

## 3. 多库管理与元数据层

白守采用 **“全局注册表 + 局部自治库”** 的双层模型。

- **全局注册中心 (`<Root>/.baishou/`)**：管理 `vault_registry.json`（记录所有已知 Vault 路径）和 `global_settings.json`（全局主题、语言等）。
- **空间自治元数据 (`<Vault>/.baishou/`)**：每个空间独立管理自己的 `ai_config.json`，允许不同空间配置不同的模型（如工作用 Claude，生活用 Gemini）。

---

## 4. AI 智能与索引层

### 4.1 双模型协作
- **推理模型 (LLM)**：执行总结、分析与对话任务。
- **嵌入模型 (Embedding)**：执行向量化索引。维度一旦确立即与 Vault 绑定，变更模型将触发全量重索引。

### 4.2 增强特性
- **混合搜索**：结合 FTS5 关键词检索与 `sqlite-vec` 语义搜索。
- **重排序 (Reranker)**：检索后进行二次语义打分，消除 Agent 幻觉。
- **原生多模态**：直接利用主模型的 Vision 能力识别附件，无需独立 OCR。

---

## 5. 同步与安全规范

- **写安全 (File Lock)**：写入物理文件前获取 `fs.open` 排他锁，严防多端并发冲突。
- **边界守卫 (Boundary)**：所有 I/O 操作强制校验 `containsPath`，严禁跨 Vault 越权访问。
- **设备指纹**：基于 Ed25519 生成设备标识，通过同步签名实现自动冲突合并与溯源。
- **版本迁移**：配置包含 `schema_version`，通过分片式的迁移脚本执行无感升级。
